<div class="layout">
  <!-- RAIL IZQUIERDO -->
  <aside class="rail rail--beige">
    <div class="rail-title-chip">
      {{ spreadLabel }} <span class="caret">▾</span>
    </div>

    <!-- Estado de mazo -->
    <div class="rail-status-min" aria-live="polite">
      <div class="shuffle-dot" [class.spin]="deckShuffling || loadingDeck"></div>

      <div class="status-text">
        @if (loadingDeck) {
          Cargando mazo…
        } @else if (deckError) {
          <span class="error">{{ deckError }}</span>
          <button type="button" (click)="loadDeckFirst()">Reintentar</button>
        } @else {
          Mazo cargado ({{ deckCount }})
        }
      </div>

      <div class="fillbar">
        <div class="fill" [style.height.%]="deckProgress"></div>
      </div>
    </div>

    <!-- Acciones rápidas -->
    <div class="rail-ghosts">
      <button class="ghost-btn spin" (click)="toggleShuffle()" [disabled]="!deckReady" title="Barajar"></button>
      <button class="ghost-btn" (click)="openHistory()" [disabled]="!deckReady" title="Historial"></button>
      <button class="ghost-btn" disabled></button>
    </div>

    <!-- Controles -->
    <div class="rail-controls">
      @if (spreadId === 'celtic-cross-10') {
        <div class="seg">
          <button type="button" [class.active]="!stepMode" (click)="stepMode=false">Completa</button>
          <button type="button" [class.active]="stepMode" (click)="prepararCruzPasoAPaso()">Una por una</button>
        </div>

        <button type="button"
                (click)="repartirCruzCompleta()"
                [disabled]="!deckReady || dealing || stepMode">
          Repartir Cruz
        </button>

        <button type="button"
                (click)="colocarSiguientePosicion()"
                [disabled]="!deckReady || dealing || !stepMode">
          Siguiente posición
        </button>
      }

      @if (isFree) {
        <div class="free-controls">
          <div class="seg">
            <button type="button" (click)="agregarCartaLibre(1)">+1</button>
            <button type="button" (click)="agregarCartaLibre(3)">+3</button>
            <button type="button" (click)="agregarCartaLibre(10)">+10</button>
          </div>
          <label>Layout:
            <select [(ngModel)]="freeLayout">
              <option value="pile">Pila</option>
              <option value="grid">Grilla</option>
              <option value="fan">Abanico</option>
            </select>
          </label>
        </div>
      }
    </div>
  </aside>

  <!-- TABLERO PRINCIPAL -->
  <main class="board" [style.backgroundImage]="boardBgUrl ? 'url(' + boardBgUrl + ')' : 'none'">

    <!-- Selector de tirada -->
    <div class="spread-select">
      <label class="label">Tipo de tirada</label>
      <div class="select-wrap">
        <select [(ngModel)]="spreadId" (ngModelChange)="onSpreadChange()">
          <option value="celtic-cross-10">Cruz Celta (10)</option>
          <option value="ppf-3">Pasado · Presente · Futuro</option>
          <option value="free">Libre (9+)</option>
        </select>
        <span class="caret">▾</span>
      </div>
    </div>

    <!-- Overlay -->
    @if (layerOverlay) {
      <div class="layer-overlay"></div>
    }

    <!-- Tabs de capas -->
    @if (isFree && layers.length > 1) {
      <div class="layer-tabs">
        @for (l of layers; track l.id; let i = $index) {
          <button type="button"
                  class="layer-chip"
                  [class.active]="i === activeLayer"
                  (click)="switchLayer(i)">
            Capa {{ l.id }}
          </button>
        }
      </div>
    }

    <!-- Slots guía (para spreads predefinidas) -->
    @if (!isFree) {
      @for (s of slots; track s.position) {
        <div class="slot"
             [style.--x]="s.x + '%'"
             [style.--y]="s.y + '%'"
             [style.--r]="s.r + 'deg'"
             [style.zIndex]="s.z"
             [attr.data-pos]="s.position"></div>
      }
    }

    <!-- CARTAS -->
    @for (pc of activeCards; track pc.position) {
      <div class="card"
           cdkDrag
           cdkDragBoundary=".board"
           [style.--x]="pc.x + '%'"
           [style.--y]="pc.y + '%'"
           [style.--r]="pc.r + 'deg'"
           [style.zIndex]="pc.z"
           [class.dealt]="pc.dealt"
           [class.faceup]="pc.faceup"
           [class.reversed]="pc.reversed"
           (click)="onCardClick(pc, $event)">

        <div class="card-inner">
          <img class="front" [src]="getFrontUrl(pc.cardId)" alt="carta" />
          <img class="back"  [src]="backUrl" alt="reverso" />
          <span class="pos-badge">#{{ pc.position }}</span>
        </div>
      </div>
    }

    <!-- MAZO -->
    <div class="deck-pile" [class.shuffle]="deckShuffling" (click)="onDeckClick()">
      <img *ngFor="let i of [0,1,2,3,4]" [src]="backUrl" alt="mazo" />
      <div class="deck-label">MAZO</div>
    </div>

    <!-- HISTORIAL -->
    @if (showHistory) {
      <div class="history-modal" (click)="closeHistory()">
        <div class="history-card" (click)="$event.stopPropagation()">
          <header>
            <h4>Historial</h4>
            <button type="button" class="close" (click)="closeHistory()">×</button>
          </header>

          @if (!historyList.length) {
            <p class="muted">Aún no hay tiradas guardadas.</p>
          } @else {
            <ul class="history-list">
              @for (h of historyList; track h.id) {
                <li>
                  <div class="meta">
                    <strong>{{ h.spreadLabel }}</strong>
                    <small *ngIf="h.ts">· {{ formatTs(h.ts!) }}</small>
                  </div>
                  <div class="actions">
                    <button type="button" (click)="loadHistory(h)">Cargar</button>
                    <button type="button" class="warn" (click)="deleteHistory(h.id)">Eliminar</button>
                  </div>
                </li>
              }
            </ul>
          }

          <footer>
            <button type="button" (click)="closeHistory()">Cerrar</button>
          </footer>
        </div>
      </div>
    }
  </main>

  <!-- PANEL DERECHO (se oculta cuando hay modal) -->
  <aside class="panel" *ngIf="!showInterpretation">
    <h3>@if (isFree) { Capa {{ layers[activeLayer].id }} } @else { Lectura }</h3>

    <div class="panel-body">
      @if (!activeCards.length) {
        <p class="muted">Aún no hay cartas. {{ isFree ? 'Añade algunas.' : 'Haz una tirada.' }}</p>
      } @else {
        <ul>
          @for (pc of activeCards; track pc.position) {
            <li>
              <strong>#{{ pc.position }}</strong> — {{ deckMap.get(pc.cardId)?.name || pc.cardId }}
              @if (pc.reversed) { <span class="rev"> (invertida)</span> }
            </li>
          }
        </ul>
      }
    </div>

    <div class="panel-footer">
      <button type="button" (click)="prevCard()" [disabled]="!activeCards.length">Anterior</button>
      <button type="button" (click)="nextCard()" [disabled]="!activeCards.length">Siguiente</button>
      <button type="button" (click)="saveToHistory()" [disabled]="!activeCards.length">Guardar</button>
    </div>

    <!-- Sin “caja” de contexto extra; el modal ya pregunta -->
    <div class="ai-interpret">
      <h3>Interpretación espiritual</h3>
      <button type="button"
              (click)="interpretarTirada()"
              [disabled]="!activeCards.length || loadingInterpret">
        {{ loadingInterpret ? 'Interpretando...' : 'Solicitar interpretación' }}
      </button>
    </div>
  </aside>
</div>

<!-- MODAL INTERPRETACIÓN -->
<div class="interpret-modal" *ngIf="showInterpretation" (click)="closeInterpret()">
  <div class="interpret-container" (click)="$event.stopPropagation()">
    <header class="interpret-header">
      <span class="icon">🔮</span>
      <h2>Interpretación</h2>
      <span class="spacer"></span>
      <button class="close-btn" (click)="closeInterpret()">×</button>
    </header>

    <div class="interpret-body">
      <!-- Usa versión segura -->
      <article class="interpret-text" [innerHTML]="interpretationSafe"></article>

      <aside class="interpret-rail">
        <h4>Cartas</h4>
        <ul>
          <li *ngFor="let c of lastDraw">
            {{ c.cardId }} <span *ngIf="c.reversed">↓</span>
          </li>
        </ul>
      </aside>
    </div>
  </div>
</div>

<!-- LOADER (WEBP animado del mago) -->
<div class="loading-overlay" *ngIf="loading || loadingInterpret" aria-live="polite" aria-busy="true">
  <img class="loading-art" src="assets/anim/wizard.webp" alt="Generando tu tirada…" />
  <p>Conjurando tu lectura…</p>
</div>
