<!-- ===========================================================
      LAYOUT GENERAL — Rail / Board / Panel
     =========================================================== -->

<div class="layout">

  <!-- ===========================================================
        RAIL IZQUIERDO (SIEMPRE VISIBLE)
       =========================================================== -->
  <aside class="rail rail--beige">

    <!-- Estado del mazo -->
    <div class="rail-status-min" aria-live="polite">
      <div class="shuffle-dot" [class.spin]="deckShuffling || loadingDeck"></div>

      <div class="status-text">
        @if (loadingDeck) {
          Cargando mazo…
        } @else if (deckError) {
          <span class="error">{{ deckError }}</span>
          <button type="button" (click)="loadDeckFirst()">Reintentar</button>
        } @else {
          Mazo cargado ({{ deckCount }})
        }
      </div>

      <div class="fillbar">
        <div class="fill" [style.height.%]="deckProgress"></div>
      </div>
    </div>

    <!-- Acciones rápidas -->
    <div class="rail-ghosts">
      <button class="ghost-btn ghost--shuffle"
              (click)="toggleShuffle()"
              [disabled]="!deckReady"
              title="Barajar"></button>

      <button class="ghost-btn ghost--history"
              (click)="openHistory()"
              title="Historial"></button>

      <button class="ghost-btn ghost--saved"
              type="button"
              (click)="openSavedReadings()"
              title="Interpretaciones guardadas"></button>
    </div>

    <!-- Controles -->
    <div class="rail-controls">

      @if (spreadId === 'celtic-cross-10') {
        <div class="seg">
          <button type="button" [class.active]="!stepMode" (click)="stepMode=false">Completa</button>
          <button type="button" [class.active]="stepMode" (click)="prepararCruzPasoAPaso()">Una por una</button>
          <button type="button"
                  (click)="repartirCruzCompleta()"
                  [disabled]="!deckReady || dealing || stepMode">
            Repartir Cruz
          </button>
        </div>
      }

      @if (isFree) {
        <div class="free-controls">
          <div class="seg">
            <button type="button" (click)="agregarCartaLibre(1)">+1</button>
            <button type="button" (click)="agregarCartaLibre(3)">+3</button>
            <button type="button" (click)="agregarCartaLibre(10)">+10</button>
          </div>

          <label>Layout:
            <select [(ngModel)]="freeLayout">
              <option value="pile">Pila</option>
              <option value="grid">Grilla</option>
              <option value="fan">Abanico</option>
            </select>
          </label>
        </div>
      }

    </div>
  </aside>



  <!-- ===========================================================
        MOBILE LAYOUT
       =========================================================== -->
  @if (isMobile) {

  <div class="mobile-layout">

    <!-- TOP BAR -->
    <div class="mobile-top-bar">

      <div class="drucoins-hud bubble">
        <img src="assets/ui/drucoin.webp" alt="Drucoins" class="coin" />
        <span class="count">{{ drucoinBalance }}</span>
      </div>

      <div class="mobile-spread-select">
        <label>Tipo de tirada</label>
        <div class="select-wrap">
          <select [(ngModel)]="spreadId" (ngModelChange)="onSpreadChange()" [disabled]="dealing">
            @if (spreads.length) {
              @for (def of spreads; track def.id) {
                <option [value]="def.id">{{ def.name }}</option>
              }
            } @else {
              <option value="celtic-cross-10">Cruz Celta</option>
              <option value="ppf-3">Pasado - Presente - Futuro</option>
              <option value="free">Libre</option>
            }
          </select>
        </div>
      </div>

      <button type="button" class="logout-btn" (click)="logout()" aria-label="Cerrar sesión">
        <svg width="18" height="18" viewBox="0 0 24 24">
          <path fill="none" stroke="currentColor" stroke-width="1.6"
                stroke-linecap="round" stroke-linejoin="round"
                  d="M9 5H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h4M16 17l5-5-5-5M21 12H9" />
        </svg>
      </button>

    </div>


    <!-- PANEL PRINCIPAL (carta / interpretación) -->
    <div class="mobile-card-panel" [class.empty]="!placed.length">

      @if (placed.length > 0) {

        <div class="card-preview">
          <img class="card-face"
               [src]="getFrontUrl(placed[focusIdx]?.cardId)"
               alt="{{ placed[focusIdx]?.cardId }}"
               (click)="openCardMeaning(placed[focusIdx])" />
        </div>

        @if (!showCardOverlay) {
          <div class="interpret-preview">
            <h4>Interpretación</h4>
            <p [innerHTML]="overlayCardMeaning || 'Toca la carta para ver su significado…'"></p>
          </div>
        } @else {
          <div class="empty-mobile-state">
            <p>Aún no hay cartas repartidas.</p>
            <button type="button" class="btn-main secondary"
                    (click)="hacerTirada()" [disabled]="!canDeal">
              Hacer tirada
            </button>
          </div>
        }

      } @else {

        <div class="empty-mobile-state">
          <p>Aún no hay cartas repartidas.</p>
          <button type="button" class="btn-main secondary"
                  (click)="hacerTirada()" [disabled]="!canDeal">
            Hacer tirada
          </button>
        </div>

      }

    </div>

    <p class="mobile-card-counter">
      Carta {{ placed.length ? (focusIdx + 1) : 0 }} / {{ placed.length || 0 }}
    </p>

    <div class="mobile-action-group">
      <button type="button"
              class="btn-main"
              (click)="startInterpretation()"
              [disabled]="!activeCards.length || !hasEnoughDrucoins || isInterpreting">
        Interpretar tirada
        <span class="cost-chip">-1 DruCoin</span>
      </button>
      @if (!hasEnoughDrucoins) {
        <p class="drucoin-warning">Necesitas DruCoins para interpretar.</p>
      }
    </div>


    <!-- BOOK PANEL -->
    <div class="book-panel" [class.open]="showBookPanel">
      <div class="page left-page" (click)="toggleBookPanel()"></div>

      <div class="page right-page">
        <header>
          <h2>El Grimorio</h2>
          <button class="close" (click)="toggleBookPanel()">Cerrar</button>
        </header>

        <section>
          <h3>Suscripciones</h3>
          <p>Modo Sabiduría: hasta 30 tiradas al mes.</p>
          <p>Modo Quántico: tiradas ilimitadas + IA avanzada.</p>
          <button class="btn-subs" (click)="openSubscription()">Ver planes</button>
        </section>

        <section>
          <h3>Cuenta</h3>
          <p>Revisa tu perfil, lecturas guardadas y progreso.</p>
          <button (click)="openProfile()">Mi cuenta</button>
        </section>

        <section>
          <h3>Información</h3>
          <button (click)="openPrivacy()">Privacidad</button>
        </section>
      </div>
    </div>


    <!-- MOBILE CAROUSEL -->
    @if (placed.length > 0) {
      <div class="mobile-carousel">
        <div class="carousel-track">
          @for (pc of placed; track pc.cardId) {
            <div class="carousel-card">
              <div class="card-wrapper" [class.reversed]="pc.reversed">
                <img class="card-face" [src]="getFrontUrl(pc.cardId)" alt="{{ pc.cardId }}" />
                <p class="card-name">{{ deckMap.get(pc.cardId)?.name || pc.cardId }}</p>
                <button (click)="openCardMeaning(pc)">Ver significado</button>
              </div>
            </div>
          }
        </div>

        <div class="carousel-nav">
          <button (click)="prevCard()">&lt;</button>
          <span>{{ focusIdx + 1 }} / {{ placed.length }}</span>
          <button (click)="nextCard()">&gt;</button>
        </div>
      </div>
    }

  </div> <!-- /mobile-layout -->

  <!-- Menú inferior móvil -->
  <div class="bottom-menu--icons">
    <button class="ghost-btn ghost--shuffle" (click)="toggleShuffle()" title="Barajar"></button>
    <button class="ghost-btn ghost--history" (click)="openHistory()" title="Historial"></button>
    <button class="ghost-btn ghost--saved" (click)="toggleBookPanel()" title="Grimorio"></button>
  </div>

  <!-- FIN MOBILE -->
  } @else {



  <!-- ===========================================================
        DESKTOP BOARD
       =========================================================== -->
  <section class="board" [style.backgroundImage]="boardBgUrl ? 'url(' + boardBgUrl + ')' : null">

    <div class="spread-select">
      <span class="label">Elige tirada</span>
      <div class="select-wrap">
        <select [(ngModel)]="spreadId"
                (ngModelChange)="onSpreadChange()"
                [disabled]="dealing">

          @if (spreads.length) {
            @for (def of spreads; track def.id) {
              <option [value]="def.id">{{ def.name }}</option>
            }
          } @else {
            <option value="celtic-cross-10">Cruz Celta</option>
            <option value="ppf-3">Pasado - Presente - Futuro</option>
            <option value="free">Libre</option>
          }
        </select>
        <span class="caret">&#9662;</span>
      </div>
    </div>


    @if (isFree && layers.length > 1) {
      <div class="layer-pills">
        @for (layer of layers; let i = $index; track layer.id) {
          <button type="button"
                  (click)="switchLayer(i)"
                  [class.active]="i === activeLayer">
            Capa {{ layer.id }}
          </button>
        }
      </div>
    }


    @if (!activeCards.length && deckReady && !dealing) {
      <p class="board-empty">Haz clic en el mazo para comenzar una lectura.</p>
    }


    <div class="slot"
         *ngFor="let slot of slots; trackBy: trackSlot"
         [style.--x]="slot.x + '%'"
         [style.--y]="slot.y + '%'"
         [style.--r]="slot.r + 'deg'"
         [attr.data-pos]="slot.position"></div>


    <div class="card"
         *ngFor="let pc of activeCards; trackBy: trackCard"
         cdkDrag
         (cdkDragEnded)="onDragEnd(pc, $event)"
         [class.dealt]="pc.dealt"
         [class.faceup]="pc.faceup"
         [class.reversed]="pc.reversed"
         [style.--x]="pc.x + '%'"
         [style.--y]="pc.y + '%'"
         [style.--r]="pc.r + 'deg'"
         [style.z-index]="pc.z">

      <div class="card-inner" (click)="onCardClick(pc, $event)">
        <img class="back" [src]="backUrl" alt="back" draggable="false" />
        <img class="front" [src]="getFrontUrl(pc.cardId)" alt="{{ pc.cardId }}" draggable="false" />
      </div>

    </div>


    <div class="board-actions">
      <button class="btn-main"
              (click)="hacerTirada()"
              [disabled]="!canDeal">
        @if (dealing) { Barajando... } @else { Nueva tirada }
      </button>
    </div>


    <div class="deck-pile"
         (click)="onDeckClick()"
         [class.shuffle]="deckShuffling || loadingDeck">

      <img *ngFor="let deck of deckStack; trackBy: trackDeck"
           [src]="backUrl"
           alt="Mazo" />

      <div class="deck-label">
        @if (loadingDeck) { Cargando }
        @else { {{ deckCount }} cartas }
      </div>

    </div>

  </section>



  <!-- DRUCOINS HUD DESKTOP -->
  <div class="drucoins-hud" title="Tus DruCoins disponibles">
    <img class="coin"
         src="https://pub-dd5dcc9095b64f479cded9e2d85818d9.r2.dev/assets/v1/cards/drucoins.webp" />
    <div class="counter">
      <strong>{{ drucoinBalance }}</strong>
      <small>DruCoins</small>
    </div>
  </div>



  <!-- PANEL DERECHO -->
  @if (!showInterpretation) {
  <aside class="panel">

    <h3>Lectura</h3>

    <div class="cards-list">
      @for (pc of activeCards; track pc.position) {
        <button type="button"
                class="card-chip"
                (click)="openCardMeaning(pc)"
                [class.reversed]="pc.reversed">
          <span class="num">#{{ pc.position }}</span>
          <span class="name">{{ deckMap.get(pc.cardId)?.name || pc.cardId }}</span>
          @if (pc.reversed) { <span class="rev">?</span> }
        </button>
      }
    </div>

    <div class="context-wrap">
      <div class="context-area">
        <label class="context-label">Contexto o pregunta:</label>
        <textarea [(ngModel)]="userContextInput"
                  rows="4"
                  placeholder="Ejemplo: Quiero entender el rumbo de mi vida profesional...">
        </textarea>
      </div>

      <div class="context-action">
        <button class="btn-papiro"
                (click)="confirmContext()"
                [disabled]="isInterpreting || !hasEnoughDrucoins">
          Interpretar tirada
          <span class="cost-chip">-1 DruCoin</span>
        </button>
        @if (!hasEnoughDrucoins) {
          <p class="drucoin-warning">No tienes DruCoins suficientes.</p>
        }
      </div>
    </div>

  </aside>
  }

} <!-- FIN DESKTOP @else -->


</div> <!-- /layout -->



<!-- INTERPRETACIÓN MOBILE MODAL -->
@if (showMobileInterpretModal) {
  <div class="mobile-interpret-overlay" (click)="closeMobileInterpretation()">
    <div class="mobile-interpret-panel" (click)="$event.stopPropagation()">
      <header>
        <h3>Interpretar tirada</h3>
        <button type="button" class="close" (click)="closeMobileInterpretation()">×</button>
      </header>

      <label class="context-label">¿Qué deseas preguntar?</label>
      <textarea [(ngModel)]="userContextInput"
                rows="4"
                placeholder="Ejemplo: Quiero entender el rumbo de mi vida profesional..."></textarea>

      <div class="actions">
        <button type="button" class="btn-pill" (click)="closeMobileInterpretation()">Cancelar</button>

        <button type="button"
                class="btn-pill primary"
                (click)="confirmMobileInterpretation()"
                [disabled]="!userContextInput.trim() || isInterpreting || !hasEnoughDrucoins">
          Interpretar
          <span class="cost-chip">-1</span>
        </button>
      </div>

      @if (!hasEnoughDrucoins) {
        <p class="drucoin-warning">Recarga tus DruCoins para interpretar.</p>
      }
    </div>
  </div>
}



<!-- HISTORIAL -->
@if (showHistory) {
  <div class="history-overlay" (click)="closeHistory()">
    <div class="history-panel" (click)="$event.stopPropagation()">

      <header>
        <h3>Historial de lecturas</h3>
        <button type="button" class="close" (click)="closeHistory()">×</button>
      </header>

      <section class="history-body">
        @if (!historyList.length) {
          <p class="history-empty">Todavía no tienes lecturas guardadas.</p>
        } @else {
          <ul class="history-list">
            @for (item of historyList; track item.id) {
              <li>
                <div class="info">
                  <strong>{{ item.spreadLabel }}</strong>
                  <small>{{ item.ts ? formatTs(item.ts) : '' }}</small>
                </div>

                <div class="actions">
                  <button (click)="loadHistory(item)">Cargar</button>
                  <button (click)="deleteHistory(item.id)">Eliminar</button>
                </div>
              </li>
            }
          </ul>
        }
      </section>

    </div>
  </div>
}



<!-- OVERLAY SIGNIFICADO -->
@if (showCardOverlay) {
  <div class="card-meaning-overlay" (click)="closeCardOverlay()">
    <div class="meaning-box" (click)="$event.stopPropagation()">

      <header>
        <h3>{{ overlayCardTitle }}</h3>
        <button class="close" (click)="closeCardOverlay()">×</button>
      </header>

      <article>
        @if (loadingCardMeaning) {
          <p><em>Consultando significado...</em></p>
        } @else {
          <p [innerHTML]="overlayCardMeaning"></p>
        }
      </article>

    </div>
  </div>
}



<!-- INTERPRETACIÓN IA -->
@if (showInterpretation) {
  <div class="interpret-modal" (click)="closeInterpret()">
    <div class="interpret-container" (click)="$event.stopPropagation()">

      <header class="interpret-header">
        <span class="icon"></span>
        <h2>Interpretación</h2>
        <button class="close-btn" (click)="closeInterpret()">×</button>
      </header>

      <div class="interpret-body">

        <article class="interpret-text" [innerHTML]="interpretationSafe"></article>

        <aside class="interpret-rail">
          <h4>Cartas</h4>
          <ul>
            @for (c of lastDraw; track c.cardId) {
              <li>{{ c.cardId }} @if (c.reversed) { <span>?</span> }</li>
            }
          </ul>
        </aside>

      </div>

    </div>
  </div>
}



<!-- LOADING IA -->
@if (isInterpreting) {
  <div class="loading-overlay" aria-busy="true">
    <img class="loading-art" src="assets/anim/wizard.webp" alt="Interpretando tu tirada…" />
    <p>El mago está interpretando tu lectura…</p>
  </div>
}



<!-- MODAL AUTOMÁTICO DE DONACIÓN (DruCoins) -->
@if (drucoinBalance <= 0 && !isInterpreting) {
  <div class="donation-overlay">
    <div class="donation-modal" (click)="$event.stopPropagation()">
      <h2>Sin DruCoins</h2>
      <p>
        Necesitas DruCoins para interpretar nuevas tiradas.
        Puedes conseguir más en la sección <strong>Premium / Drucoins</strong>.
      </p>

      <p class="donation-hint">
        Tu apoyo mantiene vivo el grimorio. 🔮
      </p>

      <div class="actions">
        <button class="btn-main" (click)="openSubscription()">Ver opciones</button>
        <button class="btn-secondary" (click)="toggleBookPanel()">Abrir Grimorio</button>
      </div>
    </div>
  </div>
}
